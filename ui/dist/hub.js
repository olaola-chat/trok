import{render as N}from"preact";import{useEffect as x,useState as k}from"preact/hooks";import{useCallback as K,useEffect as h,useState as y}from"preact/hooks";function c(t){return t=t||new Map,{all:t,on(e,n){let a=t.get(e);a?a.push(n):t.set(e,[n])},off(e,n){let a=t.get(e);a&&(n?a.splice(a.indexOf(n)>>>0,1):t.set(e,[]))},emit(e,n){let a=t.get(e);a&&a.slice().map(o=>{o(n)}),a=t.get("*"),a&&a.slice().map(o=>{o(e,n)})}}}function g(t){return`${location.href}${t}`}function E(t){"Notification"in window?Notification.permission==="granted"?new Notification(t):Notification.permission!=="denied"&&Notification.requestPermission().then(e=>{e==="granted"&&new Notification(t)}):alert("\u5F53\u524D\u6D4F\u89C8\u5668\u4E0D\u652F\u6301\u684C\u9762\u901A\u77E5")}var i=class{static mitt=c();static client=new WebSocket(location.href.replace("http","ws"));static timer;static{this.client.addEventListener("open",()=>this.client.send("PING")),this.client.addEventListener("message",e=>{if(e.data==="PONG")setTimeout(()=>this.client.send("PING"),10*1e3);else{let n=JSON.parse(e.data);this.mitt.emit("data",n)}}),this.client.addEventListener("close",e=>{clearInterval(this.timer),globalThis.confirm(`socket\u5DF2\u65AD\u5F00,\u662F\u5426\u91CD\u65B0\u94FE\u63A5? code: ${e.code}, reason: ${e.reason}`)&&globalThis.location.reload()})}};function v(){let[t,e]=y([]);return h(()=>{fetch(g("snapshot")).then(n=>n.json()).then(e).then(()=>{i.mitt.on("data",n=>{n.type==="snapshot"&&(E({pending:"\u5F00\u59CB\u5904\u7406",progress:"\u5F00\u59CB\u6253\u5305",resolved:"\u5904\u7406\u5B8C\u6210",rejected:"\u5904\u7406\u5931\u8D25"}[n.data.status]),e(a=>[...a,n.data]))})})},[]),t}import{Fragment as d,jsx as s,jsxs as r}from"preact/jsx-runtime";function m(){let t=v(),e=Object.values(Object.groupBy(t,n=>n.task.id));return s("div",{className:"p-2 h-screen overflow-y-scroll grow",ref:n=>n?.scrollTo(0,n.scrollHeight),children:e.map((n,a)=>s(b,{snapshots:n},a))})}function b(t){let[e]=t.snapshots.sort((o,l)=>{let f=l.timestamp-o.timestamp;return f!==0?f:o.status==="pending"?1:-1}),[n,a]=k([]);return x(()=>{i.mitt.on("data",o=>{o.type==="stream"&&o.data.task.id===e.task.id&&a(l=>[...l,o.data])})},[]),s(d,{children:r("div",{className:"flex flex-col items-start chat chat-start mb-5",children:[r("div",{className:"chat-header opacity-50 mb-1 text-xs ",children:[s("span",{children:e.task.origin}),s("span",{className:"text-xs badge badge-xs badge-primary mx-2",children:e.task.branch}),s("span",{className:"kbd kbd-xs",children:e.task.selector})]}),r("div",{className:`chat-bubble min-w-80 relative chat-bubble-${{pending:"neutral",progress:"neutral",resolved:"success",rejected:"error"}[e.status]}`,children:[e.logs&&s(u,{logs:e.logs}),e.commits?.length?r(d,{children:[s("h6",{children:"\u63D0\u4EA4\u8BB0\u5F55"}),s("ul",{className:"text-xs",children:e.commits.map(o=>r("li",{children:["\u2726 ",o]}))})]}):null,e.status==="progress"&&n.length!==0&&s(p,{title:"stream",theme:"info",children:n.map(o=>o.data).join("")}),e.packages?.length!==0&&r(d,{children:[s("h6",{children:"\u9879\u76EE\u5217\u8868"}),s("ul",{className:"text-xs",children:e.packages?.map(o=>s(H,{item:o}))})]})]}),r("div",{className:"chat-footer opacity-50 text-xs mt-1",children:[s("span",{className:"font-bold",children:new Date(e.timestamp).toLocaleString()}),"from:"," ",s("span",{class:"badge badge-xs badge-secondary mr-2",children:e.task.from})]})]})})}function H(t){return r(d,{children:[r("li",{className:"text-sm flex items-center gap-2",children:[{progress:s("span",{className:"loading loading-spinner loading-xs"}),pending:s("span",{className:"text-warning",children:"-"}),rejected:s("span",{className:"text-error",children:"\u2717"}),resolved:s("span",{className:"text-primary",children:"\u2713"})}[t.item.status],t.item.path]}),t.item.logs&&s(u,{logs:t.item.logs})]})}function p(t){return s("pre",{title:t.title,className:`text-xs overflow-x-scroll bg-${t.theme}-content rounded text-${t.theme} p-2 my-2 max-h-80 max-w-5xl`,ref:e=>e?.scrollTo(0,e.scrollHeight),children:s("code",{children:t.children})})}function u(t){return typeof t.logs=="string"?t.logs:r(d,{children:[s(p,{title:"stdout",theme:"info",children:t.logs.stdout}),t.logs.signal,s(p,{title:"stderr",theme:"error",children:t.logs.stderr})]})}import{jsx as T}from"preact/jsx-runtime";N(T(m,{}),document.getElementById("root"));
